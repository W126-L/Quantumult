const $ = new Env("查询油价");
// 默认山西临汾
// Loon请在参数填写shanxi/linfen
// Quantumult X 请在脚本url后添加#arg=shanxi/linfen 例:https://raw.githubusercontent.com/W126-L/Tool/master/Scripts/Meiriyoujia.js#arg=shanxi/linfen
let dataJson = {"北京油价":"/beijing","上海油价":"/shanghai","天津油价":"/tianjin","重庆油价":"/chongqing","福州汽油价格":"/fujian/fuzhou","厦门汽油价格":"/fujian/xiamen","莆田汽油价格":"/fujian/putian","三明汽油价格":"/fujian/sanming","泉州汽油价格":"/fujian/quanzhou","漳州汽油价格":"/fujian/zhangzhou","南平汽油价格":"/fujian/nanping","龙岩汽油价格":"/fujian/longyan","宁德汽油价格":"/fujian/ningde","兰州汽油价格":"/gansu/lanzhou","嘉峪关汽油价格":"/gansu/jiayuguan","金昌汽油价格":"/gansu/jinchang","白银汽油价格":"/gansu/baiyin","天水汽油价格":"/gansu/tianshui","武威汽油价格":"/gansu/wuwei","张掖汽油价格":"/gansu/zhangye","平凉汽油价格":"/gansu/pingliang","酒泉汽油价格":"/gansu/jiuquan","庆阳汽油价格":"/gansu/qingyang","定西汽油价格":"/gansu/dingxi","陇南汽油价格":"/gansu/longnan","临夏汽油价格":"/gansu/linxia","甘南汽油价格":"/gansu/gannan","广州汽油价格":"/guangdong/guangzhou","韶关汽油价格":"/guangdong/shaoguan","深圳汽油价格":"/guangdong/shenzhen","珠海汽油价格":"/guangdong/zhuhai","汕头汽油价格":"/guangdong/shantou","佛山汽油价格":"/guangdong/foshan","江门汽油价格":"/guangdong/jiangmen","湛江汽油价格":"/guangdong/zhanjiang","茂名汽油价格":"/guangdong/maoming","肇庆汽油价格":"/guangdong/zhaoqing","惠州汽油价格":"/guangdong/huizhou","梅州汽油价格":"/guangdong/meizhou","汕尾汽油价格":"/guangdong/shanwei","河源汽油价格":"/guangdong/heyuan","阳江汽油价格":"/guangdong/yangjiang","清远汽油价格":"/guangdong/qingyuan","东莞汽油价格":"/guangdong/dongguan","中山汽油价格":"/guangdong/zhongshan","潮州汽油价格":"/guangdong/chaozhou","揭阳汽油价格":"/guangdong/jieyang","云浮汽油价格":"/guangdong/yunfu","南宁汽油价格":"/guangxi/nanning","柳州汽油价格":"/guangxi/liuzhou","桂林汽油价格":"/guangxi/guilin","梧州汽油价格":"/guangxi/wuzhou","北海汽油价格":"/guangxi/beihai","防城港汽油价格":"/guangxi/fangchenggang","钦州汽油价格":"/guangxi/qinzhou","贵港汽油价格":"/guangxi/guigang","玉林汽油价格":"/guangxi/yulin","百色汽油价格":"/guangxi/baise","贺州汽油价格":"/guangxi/hezhou","河池汽油价格":"/guangxi/hechi","来宾汽油价格":"/guangxi/laibin","崇左汽油价格":"/guangxi/chongzuo","贵阳汽油价格":"/guizhou/guiyang","六盘水汽油价格":"/guizhou/liupanshui","遵义汽油价格":"/guizhou/zunyi","安顺汽油价格":"/guizhou/anshun","铜仁汽油价格":"/guizhou/tongren","黔西南汽油价格":"/guizhou/qianxinan","毕节汽油价格":"/guizhou/bijie","黔东南汽油价格":"/guizhou/qiandongnan","黔南汽油价格":"/guizhou/qiannan","海口汽油价格":"/hainan/haikou","三亚汽油价格":"/hainan/sanya","石家庄汽油价格":"/hebei/shijiazhuang","唐山汽油价格":"/hebei/tangshan","秦皇岛汽油价格":"/hebei/qinhuangdao","邯郸汽油价格":"/hebei/handan","邢台汽油价格":"/hebei/xingtai","保定汽油价格":"/hebei/baoding","张家口汽油价格":"/hebei/zhangjiakou","承德汽油价格":"/hebei/chengde","沧州汽油价格":"/hebei/cangzhou","廊坊汽油价格":"/hebei/langfang","衡水汽油价格":"/hebei/hengshui","郑州汽油价格":"/henan/zhengzhou","开封汽油价格":"/henan/kaifeng","洛阳汽油价格":"/henan/luoyang","平顶山汽油价格":"/henan/pingdingshan","安阳汽油价格":"/henan/anyang","鹤壁汽油价格":"/henan/hebi","新乡汽油价格":"/henan/xinxiang","焦作汽油价格":"/henan/jiaozuo","濮阳汽油价格":"/henan/puyang","许昌汽油价格":"/henan/xuchang","漯河汽油价格":"/henan/luohe","三门峡汽油价格":"/henan/sanmenxia","南阳汽油价格":"/henan/nanyang","商丘汽油价格":"/henan/shangqiu","信阳汽油价格":"/henan/xinyang","周口汽油价格":"/henan/zhoukou","驻马店汽油价格":"/henan/zhumadian","武汉汽油价格":"/hubei/wuhan","黄石汽油价格":"/hubei/huangshi","十堰汽油价格":"/hubei/shiyan","宜昌汽油价格":"/hubei/yichang","襄樊汽油价格":"/hubei/xiangfan","鄂州汽油价格":"/hubei/ezhou","荆门汽油价格":"/hubei/jingmen","孝感汽油价格":"/hubei/xiaogan","荆州汽油价格":"/hubei/jingzhou","黄冈汽油价格":"/hubei/huanggang","咸宁汽油价格":"/hubei/xianning","随州汽油价格":"/hubei/suizhou","恩施汽油价格":"/hubei/enshi","长沙汽油价格":"/hunan/changsha","株洲汽油价格":"/hunan/zhuzhou","湘潭汽油价格":"/hunan/xiangtan","衡阳汽油价格":"/hunan/hengyang","邵阳汽油价格":"/hunan/shaoyang","岳阳汽油价格":"/hunan/yueyang","常德汽油价格":"/hunan/changde","张家界汽油价格":"/hunan/zhangjiajie","益阳汽油价格":"/hunan/yiyang","郴州汽油价格":"/hunan/chenzhou","永州汽油价格":"/hunan/yongzhou","怀化汽油价格":"/hunan/huaihua","娄底汽油价格":"/hunan/loudi","湘西汽油价格":"/hunan/xiangxi","长春汽油价格":"/jilin/changchun","吉林市汽油价格":"/jilin/jilinshi","四平汽油价格":"/jilin/siping","辽源汽油价格":"/jilin/liaoyuan","通化汽油价格":"/jilin/tonghua","白山汽油价格":"/jilin/baishan","松原汽油价格":"/jilin/songyuan","白城汽油价格":"/jilin/baicheng","延边汽油价格":"/jilin/yanbian","南京汽油价格":"/jiangsu/nanjing","无锡汽油价格":"/jiangsu/wuxi","徐州汽油价格":"/jiangsu/xuzhou","常州汽油价格":"/jiangsu/changzhou","苏州汽油价格":"/jiangsu/suzhou","南通汽油价格":"/jiangsu/nantong","连云港汽油价格":"/jiangsu/lianyungang","淮安汽油价格":"/jiangsu/huaian","盐城汽油价格":"/jiangsu/yancheng","扬州汽油价格":"/jiangsu/yangzhou","镇江汽油价格":"/jiangsu/zhenjiang","泰州汽油价格":"/jiangsu/taizhou","宿迁汽油价格":"/jiangsu/suqian","南昌汽油价格":"/jiangxi/nanchang","景德镇汽油价格":"/jiangxi/jingdezhen","萍乡汽油价格":"/jiangxi/pingxiang","九江汽油价格":"/jiangxi/jiujiang","新余汽油价格":"/jiangxi/xinyu","鹰潭汽油价格":"/jiangxi/yingtan","赣州汽油价格":"/jiangxi/ganzhou","吉安汽油价格":"/jiangxi/jian","宜春汽油价格":"/jiangxi/yichun","抚州汽油价格":"/jiangxi/fuzhou","上饶汽油价格":"/jiangxi/shangrao","沈阳汽油价格":"/liaoning/shenyang","大连汽油价格":"/liaoning/dalian","鞍山汽油价格":"/liaoning/anshan","抚顺汽油价格":"/liaoning/fushun","本溪汽油价格":"/liaoning/benxi","丹东汽油价格":"/liaoning/dandong","锦州汽油价格":"/liaoning/jinzhou","营口汽油价格":"/liaoning/yingkou","阜新汽油价格":"/liaoning/fuxin","辽阳汽油价格":"/liaoning/liaoyang","盘锦汽油价格":"/liaoning/panjin","铁岭汽油价格":"/liaoning/tieling","朝阳汽油价格":"/liaoning/chaoyang","葫芦岛汽油价格":"/liaoning/huludao","呼和浩特汽油价格":"/neimenggu/huhehaote","包头汽油价格":"/neimenggu/baotou","乌海汽油价格":"/neimenggu/wuhai","赤峰汽油价格":"/neimenggu/chifeng","通辽汽油价格":"/neimenggu/tongliao","鄂尔多斯汽油价格":"/neimenggu/ordos","呼伦贝尔汽油价格":"/neimenggu/hulunbeir","巴彦淖尔汽油价格":"/neimenggu/bayannaoer","乌兰察布汽油价格":"/neimenggu/wulanchabu","兴安盟汽油价格":"/neimenggu/xinganmeng","锡林郭勒汽油价格":"/neimenggu/xilinguole","阿拉善汽油价格":"/neimenggu/alashan","合肥汽油价格":"/anhui/hefei","芜湖汽油价格":"/anhui/wuhu","蚌埠汽油价格":"/anhui/bengbu","淮南汽油价格":"/anhui/huainan","马鞍山汽油价格":"/anhui/maanshan","淮北汽油价格":"/anhui/huaibei","铜陵汽油价格":"/anhui/tongling","安庆汽油价格":"/anhui/anqing","黄山汽油价格":"/anhui/huangshan","滁州汽油价格":"/anhui/chuzhou","阜阳汽油价格":"/anhui/fuyang","宿州汽油价格":"/anhui/suzhou","巢湖汽油价格":"/anhui/chaohu","六安汽油价格":"/anhui/luan","亳州汽油价格":"/anhui/bozhou","池州汽油价格":"/anhui/chizhou","宣城汽油价格":"/anhui/xuancheng","银川汽油价格":"/ningxia/yinchuan","石嘴山汽油价格":"/ningxia/shizuishan","吴忠汽油价格":"/ningxia/wuzhong","固原汽油价格":"/ningxia/guyuan","中卫汽油价格":"/ningxia/zhongwei","西宁汽油价格":"/qinghai/xining","海东汽油价格":"/qinghai/haidong","海北汽油价格":"/qinghai/haibei","黄南汽油价格":"/qinghai/huangnan","海南州汽油价格":"/qinghai/hailanzhou","果洛汽油价格":"/qinghai/golog","玉树汽油价格":"/qinghai/yushu","海西汽油价格":"/qinghai/haixi","济南汽油价格":"/shandong/jinan","青岛汽油价格":"/shandong/qingdao","淄博汽油价格":"/shandong/zibo","枣庄汽油价格":"/shandong/zaozhuang","东营汽油价格":"/shandong/dongying","烟台汽油价格":"/shandong/yantai","潍坊汽油价格":"/shandong/weifang","济宁汽油价格":"/shandong/jining","泰安汽油价格":"/shandong/taian","威海汽油价格":"/shandong/weihai","日照汽油价格":"/shandong/rizhao","莱芜汽油价格":"/shandong/laiwu","临沂汽油价格":"/shandong/linyi","德州汽油价格":"/shandong/dezhou","聊城汽油价格":"/shandong/liaocheng","滨州汽油价格":"/shandong/binzhou","菏泽市汽油价格":"/shandong/heze","西安汽油价格":"/shanxi-3/xian","铜川汽油价格":"/shanxi-3/tongchuan","宝鸡汽油价格":"/shanxi-3/baoji","咸阳汽油价格":"/shanxi-3/xianyang","渭南汽油价格":"/shanxi-3/weinan","延安汽油价格":"/shanxi-3/yanan","汉中汽油价格":"/shanxi-3/hanzhong","榆林汽油价格":"/shanxi-3/yulin","安康汽油价格":"/shanxi-3/ankang","商洛汽油价格":"/shanxi-3/shangluo","太原汽油价格":"/shanxi/taiyuan","大同汽油价格":"/shanxi/datong","阳泉汽油价格":"/shanxi/yangquan","长治汽油价格":"/shanxi/changzhi","晋城汽油价格":"/shanxi/jincheng","朔州汽油价格":"/shanxi/shuozhou","晋中汽油价格":"/shanxi/jinzhong","运城汽油价格":"/shanxi/yuncheng","忻州汽油价格":"/shanxi/xinzhou","临汾汽油价格":"/shanxi/linfen","吕梁汽油价格":"/shanxi/lvliang","成都汽油价格":"/sichuan/chengdu","自贡汽油价格":"/sichuan/zigong","攀枝花汽油价格":"/sichuan/panzhihua","泸州汽油价格":"/sichuan/luzhou","德阳汽油价格":"/sichuan/deyang","绵阳汽油价格":"/sichuan/mianyang","广元汽油价格":"/sichuan/guangyuan","遂宁汽油价格":"/sichuan/suining","内江汽油价格":"/sichuan/neijiang","乐山汽油价格":"/sichuan/leshan","南充汽油价格":"/sichuan/nanchong","眉山汽油价格":"/sichuan/meishan","宜宾汽油价格":"/sichuan/yibin","广安汽油价格":"/sichuan/guangan","达州汽油价格":"/sichuan/dazhou","雅安汽油价格":"/sichuan/yaan","巴中汽油价格":"/sichuan/bazhong","资阳汽油价格":"/sichuan/ziyang","阿坝汽油价格":"/sichuan/aba","甘孜汽油价格":"/sichuan/ganzi","凉山汽油价格":"/sichuan/liangshan","拉萨汽油价格":"/xizang/lhasa","昌都汽油价格":"/xizang/changdu","山南汽油价格":"/xizang/shannan","日喀则汽油价格":"/xizang/rikeze","那曲汽油价格":"/xizang/naqu","阿里汽油价格":"/xizang/ali","林芝汽油价格":"/xizang/linzhi","哈尔滨汽油价格":"/heilongjiang/haerbin","齐齐哈尔汽油价格":"/heilongjiang/qiqihar","鸡西汽油价格":"/heilongjiang/jixi","鹤岗汽油价格":"/heilongjiang/hegang","双鸭山汽油价格":"/heilongjiang/shuangyashan","大庆汽油价格":"/heilongjiang/daqing","伊春市汽油价格":"/heilongjiang/yichunshi","佳木斯汽油价格":"/heilongjiang/jiamusi","七台河汽油价格":"/heilongjiang/qitaihe","牡丹江汽油价格":"/heilongjiang/mudanjiang","黑河汽油价格":"/heilongjiang/heihe","绥化汽油价格":"/heilongjiang/suihua","大兴安岭汽油价格":"/heilongjiang/daxinganling","乌鲁木齐汽油价格":"/xinjiang/wulumuqi","克拉玛依汽油价格":"/xinjiang/karamay","吐鲁番汽油价格":"/xinjiang/turpan","哈密汽油价格":"/xinjiang/hami","昌吉汽油价格":"/xinjiang/changji","博尔塔拉汽油价格":"/xinjiang/bortala","巴音郭楞汽油价格":"/xinjiang/bayingolin","阿克苏汽油价格":"/xinjiang/aksu","克孜勒苏汽油价格":"/xinjiang/kizilsu","喀什汽油价格":"/xinjiang/kaxgar","和田汽油价格":"/xinjiang/hotan","伊犁汽油价格":"/xinjiang/ili","塔城汽油价格":"/xinjiang/tacheng","阿勒泰汽油价格":"/xinjiang/altay","昆明汽油价格":"/yunnan/kunming","曲靖汽油价格":"/yunnan/qujing","玉溪汽油价格":"/yunnan/yuxi","保山汽油价格":"/yunnan/baoshan","昭通汽油价格":"/yunnan/zhaotong","丽江汽油价格":"/yunnan/lijiang","普洱汽油价格":"/yunnan/puer","临沧汽油价格":"/yunnan/lincang","楚雄汽油价格":"/yunnan/chuxiong","红河汽油价格":"/yunnan/honghe","文山汽油价格":"/yunnan/wenshan","西双版纳汽油价格":"/yunnan/xishuangbanna","大理汽油价格":"/yunnan/dali","德宏汽油价格":"/yunnan/dehong","怒江汽油价格":"/yunnan/nujiang","迪庆汽油价格":"/yunnan/diqing","杭州汽油价格":"/zhejiang/hangzhou","宁波汽油价格":"/zhejiang/ningbo","温州汽油价格":"/zhejiang/wenzhou","嘉兴汽油价格":"/zhejiang/jiaxing","湖州汽油价格":"/zhejiang/huzhou","绍兴汽油价格":"/zhejiang/shaoxing","金华汽油价格":"/zhejiang/jinhua","衢州汽油价格":"/zhejiang/quzhou","舟山汽油价格":"/zhejiang/zhoushan","台州汽油价格":"/zhejiang/taizhou","丽水汽油价格":"/zhejiang/lishui","罗湖汽油价格":"/guangdong/shenzhen/luohu","福田汽油价格":"/guangdong/shenzhen/futian","南山汽油价格":"/guangdong/shenzhen/nanshan","宝安汽油价格":"/guangdong/shenzhen/baoan","龙岗汽油价格":"/guangdong/shenzhen/longgang","盐田汽油价格":"/guangdong/shenzhen/yantian","92油价":"/92","95油价":"/95","98油价":"/98"}
let addr = "";
let env = $.getEnv()
if($.isLoon()){
  if($argument.arg1=="自定义地区"){
    addr = $argument.arg2
  }else{
    addr = dataJson[$argument.arg1];
  }
}
if($.isQuanX()){
  let arg = $environment.sourcePath;
  addr = arg.split('#')[1].split('=')[1]
}
var region = $.getdata("oilArea") || addr;
const query_addr = `http://m.qiyoujiage.com/${region}.shtml`;

const myRequest = {
  url: query_addr,
  headers: {
    'referer': 'http://m.qiyoujiage.com/',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36'
  }
};

$.get(myRequest, (error, response, data) => {
    const reg_price = /<dl>[\s\S]+?<dt>(.*油)<\/dt>[\s\S]+?<dd>(.*)\(元\)<\/dd>/gm;
    var prices = [];
    var m = null;
    while ((m = reg_price.exec(data)) !== null) {
        // This is necessary to avoid infinite loops with zero-width matches
        if (m.index === reg_price.lastIndex) {
            reg_price.lastIndex++;
        }
        prices.push({
            name: m[1],
            value: `${m[2]} 元/L`
        });
    }
    
    var adjust_date = '';
    var adjust_trend = '';
    var adjust_value = '';
    
    const reg_adjust_tips = /<div class="tishi"> <span>(.*)<\/span><br\/>([\s\S]+?)<br\/>/;
    const adjust_tips_match = data.match(reg_adjust_tips);
    if (adjust_tips_match && adjust_tips_match.length === 3) {
        adjust_date = adjust_tips_match[1].split('价')[1].slice(0, -2);
        adjust_value = adjust_tips_match[2];
        adjust_trend = (adjust_value.indexOf('下调') > -1 || adjust_value.indexOf('下跌') > -1) ? '↓' : '↑';
        const adjust_value_re = /([\d\.]+)元\/升-([\d\.]+)元\/升/;
        const adjust_value_re2 = /[\d\.]+元\/吨/;
        const adjust_value_match = adjust_value.match(adjust_value_re);
        if (adjust_value_match && adjust_value_match.length === 3) {
            adjust_value = `${adjust_value_match[1]}-${adjust_value_match[2]}元/L`;
        } else {
            const adjust_value_match2 = adjust_value.match(adjust_value_re2);
            if (adjust_value_match2) {
                adjust_value = adjust_value_match2[0];
            }
        }
    }
    
    const friendly_tips = `${adjust_date}调整\t${adjust_trend} ${adjust_value}`;
    if (prices.length !== 4) {
        $.log(`解析油价信息失败, URL=${query_addr}`);
        $.msg("油价查询", "解析失败", "请检查脚本或反馈给开发者");
        $.done()
    } else {
        const content = `${prices[0].name}\t\t\t${prices[0].value}\n${prices[1].name}\t\t\t${prices[1].value}\n${prices[2].name}\t\t\t${prices[2].value}\n${prices[3].name}\t\t\t${prices[3].value}`;
        $.msg("油价查询", `${friendly_tips}`, content);
        $.log("油价查询成功");
        //$.log(`油价查询结果：\n${friendly_tips}\n${content}`);
        $.done()
    }
})

// https://raw.githubusercontent.com/W126-L/Tool/master/Scripts/Evn.min.js
/*********************************** API *************************************/
function Env(t,e){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,a)=>{s.call(this,t,(t,s,r)=>{t?a(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.encoding="utf-8",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}getEnv(){return"undefined"!=typeof $environment&&$environment["surge-version"]?"Surge":"undefined"!=typeof $environment&&$environment["stash-version"]?"Stash":"undefined"!=typeof module&&module.exports?"Node.js":"undefined"!=typeof $task?"Quantumult X":"undefined"!=typeof $loon?"Loon":"undefined"!=typeof $rocket?"Shadowrocket":void 0}isNode(){return"Node.js"===this.getEnv()}isQuanX(){return"Quantumult X"===this.getEnv()}isSurge(){return"Surge"===this.getEnv()}isLoon(){return"Loon"===this.getEnv()}isShadowrocket(){return"Shadowrocket"===this.getEnv()}isStash(){return"Stash"===this.getEnv()}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const a=this.getdata(t);if(a)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,a)=>e(a))})}runScript(t,e){return new Promise(s=>{let a=this.getdata("@chavy_boxjs_userCfgs.httpapi");a=a?a.replace(/\n/g,"").trim():a;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[i,o]=a.split("@"),n={url:`http://${o}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":i,Accept:"*/*"},timeout:r};this.post(n,(t,e,a)=>s(a))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),a=!s&&this.fs.existsSync(e);if(!s&&!a)return{};{const a=s?t:e;try{return JSON.parse(this.fs.readFileSync(a))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),a=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):a?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const a=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of a)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,a)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[a+1])>>0==+e[a+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,a]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,a,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,a,r]=/^@(.*?)\.(.*?)$/.exec(e),i=this.getval(a),o=a?"null"===i?null:i||"{}":"{}";try{const e=JSON.parse(o);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),a)}catch(e){const i={};this.lodash_set(i,r,t),s=this.setval(JSON.stringify(i),a)}}else s=this.setval(t,e);return s}getval(t){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":return $persistentStore.read(t);case"Quantumult X":return $prefs.valueForKey(t);case"Node.js":return this.data=this.loaddata(),this.data[t];default:return this.data&&this.data[t]||null}}setval(t,e){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":return $persistentStore.write(t,e);case"Quantumult X":return $prefs.setValueForKey(t,e);case"Node.js":return this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0;default:return this.data&&this.data[e]||null}}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){switch(t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"],delete t.headers["content-type"],delete t.headers["content-length"]),t.params&&(t.url+="?"+this.queryStr(t.params)),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,a)=>{!t&&s&&(s.body=a,s.statusCode=s.status?s.status:s.statusCode,s.status=s.statusCode),e(t,s,a)});break;case"Quantumult X":this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:a,headers:r,body:i,bodyBytes:o}=t;e(null,{status:s,statusCode:a,headers:r,body:i,bodyBytes:o},i,o)},t=>e(t&&t.error||"UndefinedError"));break;case"Node.js":let s=require("iconv-lite");this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:a,statusCode:r,headers:i,rawBody:o}=t,n=s.decode(o,this.encoding);e(null,{status:a,statusCode:r,headers:i,rawBody:o,body:n},n)},t=>{const{message:a,response:r}=t;e(a,r,r&&s.decode(r.rawBody,this.encoding))})}}post(t,e=(()=>{})){const s=t.method?t.method.toLocaleLowerCase():"post";switch(t.body&&t.headers&&!t.headers["Content-Type"]&&!t.headers["content-type"]&&(t.headers["content-type"]="application/x-www-form-urlencoded"),t.headers&&(delete t.headers["Content-Length"],delete t.headers["content-length"]),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient[s](t,(t,s,a)=>{!t&&s&&(s.body=a,s.statusCode=s.status?s.status:s.statusCode,s.status=s.statusCode),e(t,s,a)});break;case"Quantumult X":t.method=s,this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:a,headers:r,body:i,bodyBytes:o}=t;e(null,{status:s,statusCode:a,headers:r,body:i,bodyBytes:o},i,o)},t=>e(t&&t.error||"UndefinedError"));break;case"Node.js":let a=require("iconv-lite");this.initGotEnv(t);const{url:r,...i}=t;this.got[s](r,i).then(t=>{const{statusCode:s,statusCode:r,headers:i,rawBody:o}=t,n=a.decode(o,this.encoding);e(null,{status:s,statusCode:r,headers:i,rawBody:o,body:n},n)},t=>{const{message:s,response:r}=t;e(s,r,r&&a.decode(r.rawBody,this.encoding))})}}time(t,e=null){const s=e?new Date(e):new Date;let a={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t}queryStr(t){let e="";for(const s in t){let a=t[s];null!=a&&""!==a&&("object"==typeof a&&(a=JSON.stringify(a)),e+=`${s}=${a}&`)}return e=e.substring(0,e.length-1),e}msg(e=t,s="",a="",r){const i=t=>{switch(typeof t){case void 0:return t;case"string":switch(this.getEnv()){case"Surge":case"Stash":default:return{url:t};case"Loon":case"Shadowrocket":return t;case"Quantumult X":return{"open-url":t};case"Node.js":return}case"object":switch(this.getEnv()){case"Surge":case"Stash":case"Shadowrocket":default:{let e=t.url||t.openUrl||t["open-url"];return{url:e}}case"Loon":{let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}case"Quantumult X":{let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl,a=t["update-pasteboard"]||t.updatePasteboard;return{"open-url":e,"media-url":s,"update-pasteboard":a}}case"Node.js":return}default:return}};if(!this.isMute)switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:$notification.post(e,s,a,i(r));break;case"Quantumult X":$notify(e,s,a,i(r));break;case"Node.js":}if(!this.isMuteLog){let t=["","==============📣系统通知📣=============="];t.push(e),s&&t.push(s),a&&t.push(a),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":case"Quantumult X":default:this.log("",`❗️${this.name}, 错误!`,t);break;case"Node.js":this.log("",`❗️${this.name}, 错误!`,t.stack)}}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;switch(this.log("",`🔔${this.name}, 结束! 🕛 ${s} 秒`),this.log(),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":case"Quantumult X":default:$done(t);break;case"Node.js":process.exit(1)}}}(t,e)}
/*****************************************************************************/
